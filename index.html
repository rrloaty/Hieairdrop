<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WalletConnect BNB Payment Demo</title>
<script src="https://unpkg.com/@walletconnect/web3modal@3.0.2/dist/browser.umd.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>
<style>
  body {
    background: #121212;
    color: white;
    font-family: Arial, sans-serif;
    text-align: center;
    padding: 40px;
  }
  button {
    background: #00ffc3;
    border: none;
    border-radius: 8px;
    color: black;
    font-weight: bold;
    font-size: 18px;
    padding: 14px 28px;
    cursor: pointer;
    margin: 10px;
  }
  button:disabled {
    background: #555;
    cursor: not-allowed;
  }
  #status {
    margin-top: 20px;
    font-size: 16px;
  }
</style>
</head>
<body>

<h1>Subscribe with 10 BNB Payment</h1>

<button id="connectBtn">Connect Wallet</button><br />
<button id="payBtn" disabled>Subscribe (Pay 10 BNB)</button>

<div id="status">Wallet not connected</div>

<script>
(async () => {
  const projectId = "81f700474cd5b9fb7fea7e00c2b821be"; // Your WalletConnect Project ID
  const recipientAddress = "0xa84bd2cfbBad66Ae2c5daf9aCe764dc845b94C7C"; // Your wallet address
  const bnbPriceUSD = 300; // Approximate BNB price in USD for balance check (update if needed)
  const requiredUSD = 10;   // Required USD amount to pay
  const requiredBNB = requiredUSD / bnbPriceUSD; // Calculate required BNB amount (~0.0333 BNB)

  const { Web3Modal } = window.Web3Modal;
  const ethers = window.ethers;

  const web3Modal = new Web3Modal({
    projectId,
    walletConnectVersion: 2,
    themeMode: "dark",
    chains: [
      {
        chainId: 56,
        name: "Binance Smart Chain",
        rpc: "https://bsc-dataseed.binance.org/",
        nativeCurrency: { name: "Binance Coin", symbol: "BNB", decimals: 18 },
        blockExplorerUrls: ["https://bscscan.com"],
      },
    ],
  });

  let provider;
  let signer;
  let userAddress;

  const connectBtn = document.getElementById("connectBtn");
  const payBtn = document.getElementById("payBtn");
  const status = document.getElementById("status");

  connectBtn.onclick = async () => {
    try {
      const instance = await web3Modal.connect();
      provider = new ethers.BrowserProvider(instance);
      signer = await provider.getSigner();
      userAddress = await signer.getAddress();
      status.textContent = `Connected: ${userAddress}`;
      connectBtn.disabled = true;

      // Check user BNB balance
      const balanceBigInt = await provider.getBalance(userAddress);
      const balanceBNB = Number(ethers.formatEther(balanceBigInt));
      status.textContent += ` | Balance: ${balanceBNB.toFixed(4)} BNB`;

      if (balanceBNB >= requiredBNB) {
        payBtn.disabled = false;
        status.textContent += ` | You have enough balance to pay $${requiredUSD} (≈${requiredBNB.toFixed(5)} BNB)`;
      } else {
        payBtn.disabled = true;
        status.textContent += ` | Insufficient balance to pay $${requiredUSD} (≈${requiredBNB.toFixed(5)} BNB)`;
        alert(`Your BNB balance is too low. You need at least ≈${requiredBNB.toFixed(5)} BNB (~$${requiredUSD}).`);
      }
    } catch (err) {
      alert("Failed to connect wallet or user rejected.");
      console.error(err);
      status.textContent = "Connection failed.";
    }
  };

  payBtn.onclick = async () => {
    try {
      payBtn.disabled = true;
      status.textContent = "Sending payment transaction...";
      const tx = await signer.sendTransaction({
        to: recipientAddress,
        value: ethers.parseEther(requiredBNB.toFixed(18)),
        gasLimit: 21000,
      });
      status.textContent = "Transaction sent. Waiting for confirmation...";
      await tx.wait();
      alert("Payment successful! Thank you for subscribing.");
      status.textContent = "Payment successful.";
    } catch (err) {
      alert("Transaction failed or was rejected.");
      console.error(err);
      status.textContent = "Payment failed.";
      payBtn.disabled = false;
    }
  };
})();
</script>

</body>
</html>